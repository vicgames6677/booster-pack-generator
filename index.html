<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Booster Pack Manifest Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    #walletAddress {
      margin-top: 10px;
      font-weight: bold;
    }
    #packGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }
    .pack {
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: #fff;
    }
    .pack select {
      width: 100%;
      font-weight: bold;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #aaa;
      cursor: pointer;
      appearance: none;
      background-color: #f8d7da; /* red-ish when incomplete */
      color: #333;
      transition: background-color 0.3s ease;
    }
    .pack select.assigned {
      background-color: #d4edda; /* green-ish when selected */
      border-color: #28a745;
      color: #155724;
    }
    label, input, button {
      margin: 5px 10px 5px 0;
    }
    #collectionsList {
      margin-top: 10px;
      margin-bottom: 20px;
      max-width: 600px;
    }
    .collection-row {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    .collection-row input {
      margin-right: 8px;
      padding: 4px;
      flex: 1;
    }
    .collection-row input.alias {
      max-width: 60px;
      text-transform: uppercase;
      font-weight: bold;
    }
    .collection-row button {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-weight: bold;
    }
    #loadInventoryStatus {
      margin-bottom: 10px;
      font-weight: bold;
      color: #007bff;
    }
    #exportManifest:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<h1>Booster Pack Manifest Generator</h1>

<button id="connectWallet">Connect Wallet</button>
<div id="walletAddress">Not connected</div>

<h3>Allowed Collections</h3>
<div id="collectionsList"></div>
<button id="addCollectionBtn">Add Collection</button>

<button id="loadInventoryBtn" style="margin-top:10px;">Load Inventory</button>
<div id="loadInventoryStatus"></div>

<div style="margin-top: 20px;">
  <label for="cardsPerPack">Cards per Pack:</label>
  <input type="number" id="cardsPerPack" value="5" min="1" max="50" />

  <label for="packsPerManifest">Number of Packs:</label>
  <input type="number" id="packsPerManifest" value="10" min="1" max="100" />

  <button id="generateGridBtn">Generate Pack Grid</button>
</div>

<div id="packGrid"></div>

<button id="exportManifest" style="margin-top: 20px;" disabled>Export Manifest</button>

<script>
  let provider, signer, connectedAddress = null;
  let allowedCollections = [];
  let walletInventory = {};
  let currentSelections = [];

  async function connectWallet() {
    if (window.ethereum) {
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        connectedAddress = await signer.getAddress();
        document.getElementById('walletAddress').innerText = `Connected: ${connectedAddress}`;
        clearSelections();
      } catch (err) {
        alert('Wallet connection failed.');
        console.error(err);
      }
    } else {
      alert('MetaMask not detected.');
    }
  }

  function addCollectionRow(address = '', alias = '') {
    const container = document.getElementById('collectionsList');
    const row = document.createElement('div');
    row.className = 'collection-row';

    const addrInput = document.createElement('input');
    addrInput.type = 'text';
    addrInput.placeholder = 'Collection Address (0x...)';
    addrInput.value = address;
    addrInput.className = 'address';

    const aliasInput = document.createElement('input');
    aliasInput.type = 'text';
    aliasInput.placeholder = 'Alias';
    aliasInput.value = alias.toUpperCase();
    aliasInput.className = 'alias';

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'X';
    removeBtn.onclick = () => container.removeChild(row);

    row.appendChild(addrInput);
    row.appendChild(aliasInput);
    row.appendChild(removeBtn);
    container.appendChild(row);
  }

  function gatherCollections() {
    allowedCollections = [];
    const rows = document.querySelectorAll('#collectionsList .collection-row');
    rows.forEach(row => {
      const addr = row.querySelector('.address').value.trim();
      const alias = row.querySelector('.alias').value.trim().toUpperCase();
      if (ethers.utils.isAddress(addr) && alias.length > 0) {
        allowedCollections.push({ address: addr, alias });
      }
    });
  }

  async function loadInventory() {
    gatherCollections();
    document.getElementById('loadInventoryStatus').innerText = 'Loading...';
    document.getElementById('loadInventoryStatus').style.color = '#007bff';
    walletInventory = {};

    for (const col of allowedCollections) {
      try {
        const contract = new ethers.Contract(col.address, [
          "function balanceOf(address account, uint256 id) view returns (uint256)",
        ], provider);

        for (let id = 0; id < 200; id++) {
          const balance = await contract.balanceOf(connectedAddress, id);
          if (balance > 0) {
            const key = `${col.alias}/${id}`;
            walletInventory[key] = Number(balance);
          }
        }
      } catch (e) {
        console.error(`Error loading from ${col.alias}:`, e);
      }
    }

    document.getElementById('loadInventoryStatus').innerText = 'Inventory Loaded âœ”';
    document.getElementById('loadInventoryStatus').style.color = 'green';
  }

  function clearSelections() {
    currentSelections = [];
    document.getElementById('packGrid').innerHTML = '';
    document.getElementById('exportManifest').disabled = true;
  }

  function generatePackGrid() {
    clearSelections();
    const cardsPerPack = parseInt(document.getElementById('cardsPerPack').value);
    const packsPerManifest = parseInt(document.getElementById('packsPerManifest').value);
    const packGrid = document.getElementById('packGrid');

    // Clone the walletInventory for decrementing without losing original counts
    const inventoryCounts = {...walletInventory};

    for (let i = 0; i < packsPerManifest; i++) {
      const packDiv = document.createElement('div');
      packDiv.className = 'pack';
      currentSelections[i] = [];

      for (let j = 0; j < cardsPerPack; j++) {
        const select = document.createElement('select');
        const placeholder = document.createElement('option');
        placeholder.text = 'Select a token';
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);

        for (const key in inventoryCounts) {
          const count = inventoryCounts[key];
          const option = document.createElement('option');
          option.value = key;
          option.text = `${key} (${count} left)`;
          option.disabled = count <= 0;
          select.appendChild(option);
        }

        select.addEventListener('change', (e) => {
          const value = e.target.value;
          const packIndex = i;
          const cardIndex = j;

          // Increase inventory of previously selected token for this dropdown, if any
          const prev = currentSelections[packIndex][cardIndex];
          if (prev) {
            inventoryCounts[prev]++;
          }

          // Decrement newly selected token inventory
          if (inventoryCounts[value] > 0) {
            inventoryCounts[value]--;
            currentSelections[packIndex][cardIndex] = value;
            updateGridSelections(inventoryCounts);
          } else {
            alert("No copies left for selected token.");
            // revert selection to blank
            e.target.value = '';
            delete currentSelections[packIndex][cardIndex];
          }
        });

        packDiv.appendChild(select);
      }

      packGrid.appendChild(packDiv);
    }
    updateGridSelections(inventoryCounts);
  }

  // Update all dropdowns and their options + colors + export button enablement
  function updateGridSelections(inventoryCounts) {
    const selects = document.querySelectorAll('#packGrid select');
    selects.forEach(select => {
      const currentVal = select.value;
      // Clear options
      select.innerHTML = '';

      const placeholder = document.createElement('option');
      placeholder.text = 'Select a token';
      placeholder.disabled = true;
      if (!currentVal) placeholder.selected = true;
      select.appendChild(placeholder);

      for (const key in inventoryCounts) {
        const count = inventoryCounts[key];
        const option = document.createElement('option');
        option.value = key;
        option.text = `${key} (${count} left)`;
        option.disabled = count <= 0 && key !== currentVal;
        if (key === currentVal) {
          option.selected = true;
        }
        select.appendChild(option);
      }

      select.className = currentVal ? 'assigned' : '';
    });

    // Check if all packs are fully assigned (no empty selects)
    const allComplete = currentSelections.length > 0 &&
      currentSelections.every(pack => pack.length > 0 && pack.every(Boolean));

    document.getElementById('exportManifest').disabled = !allComplete;
  }

  function exportManifest() {
    const data = currentSelections.map(pack => pack.slice());
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'booster-manifest.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  document.getElementById('connectWallet').onclick = connectWallet;
  document.getElementById('addCollectionBtn').onclick = () => addCollectionRow();
  document.getElementById('loadInventoryBtn').onclick = loadInventory;
  document.getElementById('generateGridBtn').onclick = generatePackGrid;
  document.getElementById('exportManifest').onclick = exportManifest;

  // Init with one empty collection row
  addCollectionRow();
</script>

</body>
</html>
